import Back from 'SVGs/Back'
import Administrators from 'components/Organization/Settings/Administrators'
import MainInformation from 'components/Organization/Settings/MainInformation'
import Reward from 'components/Organization/Settings/Reward'
import TabControl, {
  Tab,
  TabMap
} from 'components/Organization/Settings/TabControl'
import TaskManager from 'components/Organization/Settings/TaskManager'
import TreasuryHistory from 'components/Organization/Settings/TreasuryHistory'
import Wallet from 'components/Organization/Settings/Wallet'
import {
  Action,
  Deposit,
  GetActionsDocument,
  GetDepositsDocument,
  GetOrganizationDocument,
  Organization
} from 'graphclient'
import client from 'graphclient/client'
import { useGetOrganizationQuery, usePolling } from 'hooks'
import type {
  GetServerSideProps,
  GetServerSidePropsContext,
  NextPage
} from 'next'
import { useTranslation } from 'next-i18next'
import { serverSideTranslations } from 'next-i18next/serverSideTranslations'
import Head from 'next/head'
import Link from 'next/link'
import { useEffect, useState } from 'react'
import { wrapper } from 'state/store'
import { Converter } from 'utils/converter'

export const getServerSideProps: GetServerSideProps =
  wrapper.getServerSideProps(
    (store) => async (context: GetServerSidePropsContext) => {
      const orgId =
        typeof context.params?.id === 'string'
          ? context.params?.id
          : context.params?.id?.[0] || '0'
      const locale = context.locale ?? ''

      let activeTab = Tab.INFORMATION

      const redirect = (tab: Tab) => {
        return {
          redirect: {
            destination: `/organization/${orgId}/settings/${TabMap[tab]}`,
            permanent: false
          }
        }
      }

      if (context.params?.section && context.params?.section?.length > 0) {
        const tab = Object.entries(TabMap).find(
          ([k, v]) => v === context.params?.section?.[0]
        )?.[0]
        if (
          tab &&
          parseInt(tab) >= Tab.INFORMATION &&
          parseInt(tab) <= Tab.TASK_MANAGER_API
        ) {
          activeTab = parseInt(tab)
        } else return redirect(activeTab)
      } else return redirect(activeTab)

      const { data } = await client.query({
        query: GetOrganizationDocument,
        variables: {
          id: orgId
        }
      })

      const { data: actions } = await client.query({
        query: GetActionsDocument,
        variables: {
          orderBy: 'completedAt',
          orderDirection: 'desc',
          where: {
            orgId: orgId as any,
            actionType: 0,
            executed: true
          }
        }
      })

      const { data: deposits } = await client.query({
        query: GetDepositsDocument,
        variables: {
          orderBy: 'completedAt',
          orderDirection: 'desc',
          where: {
            orgId: orgId as any
          }
        }
      })

      return {
        props: {
          activeTab,
          org: data?.organization,
          withdrawals: actions.actions,
          deposits: deposits.deposits,
          ...(await serverSideTranslations(locale, [
            'common',
            'organization',
            'header',
            'tasks'
          ]))
        }
      }
    }
  )

interface PageProps {
  activeTab: Tab
  org: Organization
  withdrawals: Action[]
  deposits: Deposit[]
}

const OrganizationPage: NextPage<PageProps> = ({
  org,
  withdrawals,
  deposits,
  ...props
}) => {
  const { t } = useTranslation('organization')
  const [organization, setOrganization] = useState(
    Converter.OrganizationFromQuery(org)
  )
  const { data, startPolling, stopPolling } = useGetOrganizationQuery({
    variables: {
      id: org.id
    }
  })
  usePolling(startPolling, stopPolling)

  useEffect(() => {
    if (data?.organization) {
      setOrganization(Converter.OrganizationFromQuery(data.organization))
    }
  }, [data])

  const [activeTab, setActiveTab] = useState(props.activeTab)

  const handleTabNavigation = (tab: Tab) => {
    setActiveTab(tab)
    history.replaceState(
      undefined,
      'Settings',
      `/organization/${organization.id}/settings/${TabMap[tab]}`
    )
  }

  return (
    <div className='layout-container pb-20'>
      <Head>
        <title>Buildstream: Organizations</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <div className='grid-layout pt-10 md:pt-24 pb-3'>
        <div className='w-fit col-span-4 md:col-span-8 lg:col-span-12 2xl:col-span-4'>
          <Link href={`/organization/${organization.id}`}>
            <button className='flex items-center text-lg justify-center gap-x-3 lg:w-full btn-outline border-[#EFF0F1] hover:border-gray-500 bg-white focus:border-gray-500'>
              <Back />
              {t('back_to_organization')}
            </button>
          </Link>
        </div>
      </div>
      <div className='grid-layout pb-10 md:pb-24'>
        <div className='hidden 2xl:block col-span-4 md:col-span-3 lg:col-span-4 2xl:col-span-3'>
          <div className='rounded-2xl'>
            {activeTab === Tab.TREASURY && (
              <Wallet organization={organization} />
            )}
          </div>
        </div>
        <div className='col-span-4 md:col-span-5 lg:col-span-8 2xl:col-span-6'>
          <h2 className='text-[40px] leading-none font-bold mb-8'>
            {t('organization_settings')}
          </h2>
          <TabControl
            onChange={handleTabNavigation}
            active={activeTab}
            tabs={{
              [Tab.INFORMATION]: (
                <MainInformation organization={organization} />
              ),
              [Tab.TREASURY]: (
                <TreasuryHistory
                  organization={organization}
                  withdrawalHistory={withdrawals?.map((a) =>
                    Converter.ActionFromQuery(a)
                  )}
                  depositHistory={deposits?.map((d) =>
                    Converter.DepositFromQuery(d)
                  )}
                />
              ),
              [Tab.ADMINISTRATORS]: (
                <Administrators organization={organization} />
              ),
              [Tab.TASK_MANAGER_API]: (
                <TaskManager organization={organization} />
              )
            }}
          />
        </div>
        <div className='col-span-4 md:col-span-3 lg:col-span-4 2xl:col-span-3'>
          <div className='rounded-2xl'>
            {activeTab === Tab.TREASURY && (
              <>
                <div className='2xl:hidden mb-4'>
                  <Wallet organization={organization} />
                </div>
                <Reward organization={organization} />
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}

export default OrganizationPage
